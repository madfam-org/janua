# Test Coverage Audit Report

**Date**: 2026-01-24
**Generated by**: Claude Code Automated Audit
**Scope**: `apps/api` FastAPI Backend

---

## Executive Summary

| Metric | Value | Status |
|--------|-------|--------|
| **Overall Coverage** | 31.36% | :white_check_mark: Exceeds 25% threshold |
| **Total Statements** | 31,610 | - |
| **Statements Missed** | 21,697 | - |
| **Unit Tests Passed** | 1,620 | - |
| **Tests Skipped** | 63 | - |
| **Source Files** | 267 | - |
| **Unit Test Files** | 59 | - |
| **Integration Test Files** | 29 | - |
| **Quarantined Test Files** | 54 | :warning: Needs restoration |

### Key Findings

1. **Coverage exceeds threshold** - 31.36% vs 25% required
2. **Critical gaps exist** - 17 modules at 0% coverage
3. **Quarantine backlog** - 54 tests need restoration (22 services, 11 root, 6 routers)
4. **High-value targets identified** - alerting, compliance, organizations modules
5. **SSO module well-tested** - 65-75% coverage in core SSO services

---

## Module-by-Module Coverage

### :red_circle: Critical: 0% Coverage (P0)

These modules have zero test coverage and represent the highest risk.

| Module | Lines | Impact |
|--------|-------|--------|
| `alerting.application.services` | 451 | Alert orchestration, notifications |
| `alerting.domain.models` | 468 | Core alert data models |
| `alerting.domain.services` | 348 | Alert evaluation logic |
| `alerting.infrastructure` | 521 | Email/Slack notifiers, repositories |
| `compliance.monitoring` | 586 | Compliance control monitoring |
| `compliance.privacy` | 506 | GDPR, consent, retention managers |
| `organizations.application` | 218 | Commands, queries for orgs |
| `organizations.domain` | 266 | Org/membership domain models |
| `organizations.infrastructure` | 110 | Org repository layer |
| `organizations.interfaces` | 293 | REST controllers, DTOs |
| `services.payment` | 757 | Stripe, Polar, Conekta providers |

**Total uncovered lines in P0 modules**: 4,524 lines

### :orange_circle: Low Coverage (P1) - 1-15%

| Module | Coverage | Lines | Gap |
|--------|----------|-------|-----|
| `compliance` | 0.5% | 2,772 | Critical compliance audit/incident code |
| `alerting` (core) | 1.5% | 337 | Alert system entry points |
| `graphql` | 1.5% | 327 | GraphQL API schema |
| `services.email` | 2.0% | 205 | Email notification services |
| `routers` (root) | 2.6% | 499 | Top-level router config |
| `monitoring` | 3.9% | 360 | APM, metrics collection |
| `sso.infrastructure` | 5.8% | 103 | SSO config repository |
| `sso.application` | 11.5% | 78 | SSO orchestrator |
| `auth` | 15.9% | 473 | Auth router |

### :yellow_circle: Medium Coverage (P2) - 15-50%

| Module | Coverage | Lines | Notes |
|--------|----------|-------|-------|
| `alerting.core` | 17.9% | 457 | Alert manager, evaluator |
| `sdk` | 24.4% | 892 | SDK auth, client, error handling |
| `routers.v1` | 30.9% | 5,443 | API v1 endpoints (largest module) |
| `logging` | 34.9% | 275 | Log analyzer |
| `middleware` | 35.5% | 1,297 | Rate limit, input validation |
| `core` | 36.5% | 2,851 | Caching, RBAC, database |
| `users` | 36.5% | 148 | User router |
| `services` | 49.4% | 6,267 | Business logic services |

### :green_circle: Good Coverage (P3) - 50%+

| Module | Coverage | Lines | Notes |
|--------|----------|-------|-------|
| `routers.v1.organizations` | 58.8% | 291 | Org API endpoints |
| `sso.domain.services` | 65.8% | 543 | Attribute mapper, certificate, metadata |
| `sso.domain.protocols` | 74.7% | 284 | OIDC, SAML protocols |
| `utils` | 75.0% | 24 | Logger utility |
| `schemas` | 83.9% | 249 | API schemas |
| `models` | 88.6% | 1,787 | Data models |

---

## Critical Gap Analysis

### 1. Alerting Infrastructure (0% coverage)

**Files affected**: 32 files, ~2,500 lines

```
app/alerting/
├── application/services/     # 0% - orchestrator, dispatcher
├── core/                     # 18% - manager, evaluator (partial)
├── domain/                   # 0% - models, services
├── infrastructure/           # 0% - notifiers, repositories
└── notification/             # 0% - sender
```

**Risk**: Alert failures in production would be undetected. Email/Slack notification bugs could cause silent failures.

**Priority**: P0 - Create unit tests for `AlertManager`, `NotificationDispatcher`, `EmailNotifier`, `SlackNotifier`

### 2. Compliance Module (0.5% coverage)

**Files affected**: 17 files, ~3,300 lines

```
app/compliance/
├── audit.py              # 5% - audit trail
├── dashboard.py          # 0% - compliance dashboard
├── incident.py           # 0% - incident management
├── monitor.py            # 0% - compliance monitoring
├── policies.py           # 0% - policy engine
├── privacy.py            # 0% - privacy controls
├── monitoring/           # 0% - control status, evidence
└── privacy/              # 0% - GDPR, consent, retention
```

**Risk**: GDPR/compliance violations undetected. Audit trails may fail silently.

**Priority**: P0 - Critical for regulatory compliance

### 3. Organizations DDD Architecture (0% coverage)

**Files affected**: 18 files, ~900 lines

```
app/organizations/
├── application/
│   ├── commands/         # 0% - create_organization, invite_member
│   └── queries/          # 0% - get_organization, list_memberships
├── domain/
│   ├── models/           # 0% - organization, membership
│   └── services/         # 0% - membership_service
├── infrastructure/
│   └── repositories/     # 0% - organization_repository
└── interfaces/rest/      # 0% - controller, router, DTOs
```

**Risk**: Organization CRUD operations untested. RBAC issues could allow privilege escalation.

**Priority**: P0 - Core multi-tenancy feature

### 4. Payment Services (0% coverage)

**Files affected**: 6 files, ~757 lines

```
app/services/payment/
├── base.py               # 0% - payment provider interface
├── stripe_provider.py    # 0% - Stripe integration
├── polar_provider.py     # 0% - Polar integration
├── conekta_provider.py   # 0% - Conekta integration
├── geolocation.py        # 0% - geo-based provider selection
└── router.py             # 0% - payment endpoints
```

**Risk**: Payment processing failures could cause revenue loss or double charges.

**Priority**: P1 - Financial impact

### 5. GraphQL Schema (1.5% coverage)

**File affected**: `app/graphql/schema.py` - 327 lines

**Risk**: GraphQL API has no validation tests. Schema changes could break clients.

**Priority**: P1 - API contract stability

---

## Quarantine Analysis

54 test files are quarantined and excluded from CI. Categorized by directory:

| Category | Count | Files | Restoration Priority |
|----------|-------|-------|---------------------|
| **services** | 22 | billing, auth, monitoring, compliance, RBAC, etc. | P0 - Highest value |
| **root** | 11 | config, auth, main, middleware | P1 - Infrastructure |
| **routers** | 6 | auth, MFA, passkey comprehensive tests | P1 - API coverage |
| **core** | 3 | redis, circuit breaker, utilities | P2 - Stability |
| **middleware** | 2 | rate limiting tests | P2 - Performance |
| **models** | 1 | user model tests | P3 - Low impact |
| **auth** | 1 | auth router tests | P1 - Security |

### High-Value Quarantine Restoration Targets

These quarantined tests, once fixed, would significantly improve coverage:

1. **`services/test_billing_service_comprehensive.py`** - Payment/subscription logic
2. **`services/test_auth_service_comprehensive.py`** - Core authentication
3. **`services/test_compliance_service_comprehensive.py`** - Regulatory compliance
4. **`services/test_rbac_service_comprehensive.py`** - Access control
5. **`services/test_monitoring_service.py`** - Observability
6. **`routers/test_auth_router_comprehensive.py`** - Auth API endpoints

### Common Quarantine Issues

Based on file naming patterns:
- `*_comprehensive.py` - Likely need mock/fixture updates
- `*_working.py` - Partially functional, need completion
- `*_focused.py` - Subset tests, may conflict with others

---

## Coverage Targets

### Recommended Milestones

| Milestone | Target Coverage | Timeline | Key Actions |
|-----------|-----------------|----------|-------------|
| **M1: Stabilize** | 35% | +2 weeks | Fix quarantined service tests |
| **M2: Critical Paths** | 45% | +4 weeks | Cover alerting, compliance |
| **M3: API Complete** | 55% | +6 weeks | Cover all routers |
| **M4: Production Ready** | 70% | +10 weeks | Full service coverage |

### Per-Module Targets

| Module | Current | Target | Gap to Close |
|--------|---------|--------|--------------|
| `alerting` | 0-18% | 60% | +42% |
| `compliance` | 0.5% | 70% | +70% (regulatory requirement) |
| `organizations` | 0% | 60% | +60% |
| `services.payment` | 0% | 80% | +80% (financial risk) |
| `graphql` | 1.5% | 50% | +48% |
| `routers.v1` | 31% | 60% | +29% |
| `services` | 49% | 70% | +21% |

---

## Test Health Metrics

### Test Execution Stats

| Metric | Value |
|--------|-------|
| Total test time | 75.20s |
| Tests per second | 21.5 |
| Pass rate | 96.3% (1620/1683) |
| Skip rate | 3.7% (63/1683) |
| Warnings | 1,041 (mostly async cleanup) |

### Warning Analysis

Primary warning source: `PytestUnraisableExceptionWarning` from `ConnectionManager._heartbeat`

**Recommendation**: Add proper async cleanup in WebSocket tests to eliminate warnings.

---

## Actionable Recommendations

### Immediate (This Sprint)

1. **Fix top 5 quarantined service tests** - Estimated +8% coverage
2. **Add basic alerting tests** - `AlertManager.create_alert()`, `AlertManager.evaluate()`
3. **Add compliance audit tests** - `AuditLogger.log()`, `ComplianceMonitor.check()`
4. **Fix async cleanup warnings** - Proper teardown in WebSocket tests

### Short-Term (Next 2 Sprints)

1. **Create organizations test suite** - Cover CRUD, RBAC, membership
2. **Add payment integration tests** - Mock Stripe/Polar APIs
3. **Restore quarantined router tests** - Auth, MFA, passkey flows
4. **Add GraphQL schema tests** - Query/mutation validation

### Medium-Term (Next Quarter)

1. **Reach 50% coverage** - Focus on high-risk modules
2. **Add E2E API tests** - Full flow validation
3. **Implement mutation testing** - Validate test quality
4. **Performance regression tests** - Rate limiting, caching

---

## Report Artifacts

| Artifact | Location |
|----------|----------|
| HTML Coverage Report | `apps/api/htmlcov/index.html` |
| XML Coverage Report | `apps/api/coverage.xml` |
| Pytest Configuration | `apps/api/pytest.ini` |
| Coverage Configuration | `apps/api/pyproject.toml` |
| Quarantine Directory | `apps/api/tests/quarantine/` |
| This Audit Report | `apps/api/docs/COVERAGE_AUDIT_2026-01-24.md` |

---

## Appendix: Files with Zero Coverage

<details>
<summary>Click to expand full list (81 files)</summary>

```
app/alerting/application/services/alert_orchestrator.py
app/alerting/application/services/notification_dispatcher.py
app/alerting/core/notification_sender.py
app/alerting/domain/models/alert.py
app/alerting/domain/models/notification.py
app/alerting/domain/models/rule.py
app/alerting/domain/services/alert_evaluator.py
app/alerting/domain/services/notification_strategy.py
app/alerting/evaluation/evaluator.py
app/alerting/infrastructure/notifications/email_notifier.py
app/alerting/infrastructure/notifications/slack_notifier.py
app/alerting/infrastructure/repositories.py
app/alerting/manager.py
app/alerting/metrics.py
app/alerting/models.py
app/alerting/notification/sender.py
app/auth/router_completed.py
app/beta_auth.py
app/compliance/dashboard.py
app/compliance/incident.py
app/compliance/monitor.py
app/compliance/monitoring/compliance_monitor.py
app/compliance/monitoring/control_monitor.py
app/compliance/monitoring/control_status.py
app/compliance/monitoring/evidence_collector.py
app/compliance/policies.py
app/compliance/privacy.py
app/compliance/privacy/consent_manager.py
app/compliance/privacy/data_subject_handler.py
app/compliance/privacy/gdpr_compliance.py
app/compliance/privacy/privacy_manager.py
app/compliance/privacy/privacy_models.py
app/compliance/privacy/privacy_types.py
app/compliance/privacy/retention_manager.py
app/compliance/sla.py
app/compliance/support.py
app/core/error_logging.py
app/core/logger.py
app/core/test_config.py
app/middleware/apm_middleware.py
app/middleware/logging_middleware.py
app/middleware/performance_tracking.py
app/monitoring/apm.py
app/organizations/application/base.py
app/organizations/application/commands/create_organization.py
app/organizations/application/commands/invite_member.py
app/organizations/application/queries/get_organization.py
app/organizations/application/queries/list_memberships.py
app/organizations/domain/models/membership.py
app/organizations/domain/models/organization.py
app/organizations/domain/services/membership_service.py
app/organizations/infrastructure/repositories/organization_repository.py
app/organizations/interfaces/rest/dto/requests.py
app/organizations/interfaces/rest/dto/responses.py
app/organizations/interfaces/rest/organization_controller.py
app/organizations/interfaces/rest/router.py
app/sdk/documentation.py
app/sdk/versioning.py
app/services/admin_notifications.py
app/services/billing_webhooks.py
app/services/compliance_service_complete.py
app/services/email.py
app/services/email/notifications.py
app/services/email/resend_service.py
app/services/enhanced_email_service.py
app/services/payment/base.py
app/services/payment/conekta_provider.py
app/services/payment/geolocation.py
app/services/payment/polar_provider.py
app/services/payment/router.py
app/services/payment/stripe_provider.py
app/services/webhook_enhanced.py
app/sso/domain/services/oidc_discovery.py
```

</details>

---

*Generated by Claude Code | Janua Test Coverage Audit System*
