apiVersion: apps/v1
kind: Deployment
metadata:
  name: janua-api
  namespace: janua
  labels:
    app: janua-api
    app.kubernetes.io/name: janua-api
    app.kubernetes.io/component: api
    app.kubernetes.io/part-of: janua
  annotations:
    # Prevent Switchyard from overriding our deployment
    # janua-api uses K8s secrets (janua-secrets) for env vars, NOT Switchyard's database
    enclii.dev/reconcile: "disabled"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: janua-api
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: janua-api
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8000"
        prometheus.io/path: "/metrics"
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      imagePullSecrets:
        - name: ghcr-credentials
      containers:
        - name: janua-api
          securityContext:
            privileged: false
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
          image: ghcr.io/madfam-org/janua-api:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
          env:
            # Required - from secrets
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: database-url
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: redis-url
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: jwt-secret
            - name: JWT_PRIVATE_KEY
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: jwt-private-key
            - name: JWT_PUBLIC_KEY
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: jwt-public-key
            - name: SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: secret-key
            - name: FIELD_ENCRYPTION_KEY
              valueFrom:
                secretKeyRef:
                  name: janua-secrets
                  key: field-encryption-key
            # Configuration
            - name: PORT
              value: "8080"
            - name: ENVIRONMENT
              value: production
            - name: LOG_LEVEL
              value: info
            - name: BASE_URL
              value: https://api.janua.dev
            # Email
            - name: EMAIL_PROVIDER
              value: resend
            - name: EMAIL_FROM
              value: noreply@janua.dev
            # Custom domain for white-label OIDC issuer (auth.madfam.io instead of api.janua.dev)
            - name: JANUA_CUSTOM_DOMAIN
              value: auth.madfam.io
            # CORS - All allowed frontend origins
            - name: CORS_ORIGINS
              value: "https://admin.janua.dev,https://app.janua.dev,https://api.enclii.dev,https://app.enclii.dev,https://admin.enclii.dev,https://auth.madfam.io,https://app.dhan.am"
            # Cookie domain for cross-subdomain SSO (api.janua.dev cookies shared with app.janua.dev)
            - name: COOKIE_DOMAIN
              value: ".janua.dev"
            # Features
            - name: ENABLE_DOCS
              value: "true"
            - name: ENABLE_SIGNUPS
              value: "true"
            - name: ENABLE_OAUTH
              value: "true"
            - name: ENABLE_MFA
              value: "true"
            - name: ENABLE_MAGIC_LINKS
              value: "true"
            - name: ENABLE_ORGANIZATIONS
              value: "true"
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
              httpHeaders:
                - name: Host
                  value: localhost
            initialDelaySeconds: 15
            periodSeconds: 30
            timeoutSeconds: 5
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
              httpHeaders:
                - name: Host
                  value: localhost
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
          startupProbe:
            httpGet:
              path: /health
              port: 8080
              httpHeaders:
                - name: Host
                  value: localhost
            initialDelaySeconds: 10
            periodSeconds: 5
            failureThreshold: 30
            timeoutSeconds: 5
      restartPolicy: Always
      terminationGracePeriodSeconds: 30
