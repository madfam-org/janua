#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Prevent environment files from being committed
if git diff --cached --name-only | grep -qE "^\.env$|\.env\.local$|\.env\.production$|\.env\.staging$|\.env\.development$"; then
  echo "‚ùå ERROR: Environment files detected in commit!"
  echo ""
  echo "The following environment files should NOT be committed:"
  git diff --cached --name-only | grep -E "^\.env|\.env\."
  echo ""
  echo "These files may contain sensitive information."
  echo "Please use .env.example files for documentation instead."
  echo ""
  echo "To unstage these files, run:"
  echo "  git reset HEAD <file>"
  exit 1
fi

# File size check - prevent overly large files
echo "üìè Checking file sizes..."
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(py|ts|tsx|js|jsx)$")
FILE_SIZE_ERRORS=0
FILE_SIZE_WARNINGS=0

# Exclusion patterns
EXCLUDE_PATTERNS="alembic/versions|__pycache__|node_modules|\.venv|dist|\.next|htmlcov|scripts/"

for file in $STAGED_FILES; do
  # Skip excluded patterns
  if echo "$file" | grep -qE "$EXCLUDE_PATTERNS"; then
    continue
  fi

  # Skip test files for error threshold (warning only)
  IS_TEST=$(echo "$file" | grep -qE "test|spec|__tests__" && echo "1" || echo "0")

  if [ -f "$file" ]; then
    LINES=$(wc -l < "$file" | tr -d ' ')

    if [ "$LINES" -gt 800 ] && [ "$IS_TEST" = "0" ]; then
      if [ $FILE_SIZE_ERRORS -eq 0 ]; then
        echo ""
        echo "‚ùå ERROR: Files exceeding 800 line limit:"
      fi
      FILE_SIZE_ERRORS=$((FILE_SIZE_ERRORS + 1))
      echo "  $file ($LINES lines)"
    elif [ "$LINES" -gt 600 ]; then
      if [ $FILE_SIZE_WARNINGS -eq 0 ] && [ $FILE_SIZE_ERRORS -eq 0 ]; then
        echo ""
      fi
      if [ $FILE_SIZE_WARNINGS -eq 0 ]; then
        echo "‚ö†Ô∏è  WARNING: Files exceeding 600 line limit:"
      fi
      FILE_SIZE_WARNINGS=$((FILE_SIZE_WARNINGS + 1))
      echo "  $file ($LINES lines)"
    fi
  fi
done

if [ $FILE_SIZE_ERRORS -gt 0 ]; then
  echo ""
  echo "‚ùå $FILE_SIZE_ERRORS file(s) exceed 800 lines."
  echo "Consider refactoring these files before committing."
  echo "Exclusions: migrations, scripts, test files"
  exit 1
fi

if [ $FILE_SIZE_WARNINGS -gt 0 ]; then
  echo ""
  echo "‚ö†Ô∏è  $FILE_SIZE_WARNINGS file(s) approaching size limit (600-800 lines)"
  echo "Consider refactoring soon."
  sleep 2
fi

# Prevent debug statements in production code (warning only)
DEBUG_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E "\.(ts|tsx|js|jsx|py)$" | grep -v "test\|spec\|\.example")
if [ -n "$DEBUG_FILES" ]; then
  DEBUG_COUNT=0
  for file in $DEBUG_FILES; do
    # Check for console.log/console.error/print() in non-test files
    if git diff --cached "$file" | grep -E "^\+.*console\.(log|error|warn|debug)\(|^\+.*print\(" | grep -v "logger\." > /dev/null; then
      if [ $DEBUG_COUNT -eq 0 ]; then
        echo "‚ö†Ô∏è  WARNING: Debug statements detected in staged files:"
        echo ""
      fi
      DEBUG_COUNT=$((DEBUG_COUNT + 1))
      echo "  - $file"
    fi
  done

  if [ $DEBUG_COUNT -gt 0 ]; then
    echo ""
    echo "Consider using the logger utility instead:"
    echo "  TypeScript: import { createLogger } from '@janua/core/utils/logger'"
    echo "  Python: from app.utils.logger import create_logger"
    echo ""
    echo "Press Ctrl+C to cancel commit, or Continue to commit anyway."
    sleep 2
  fi
fi

echo "‚úÖ Pre-commit checks passed"
