name: Deploy All Services

# Comprehensive deployment workflow for all Janua services
# Fixes 502 errors by ensuring all services are deployed with fresh credentials

on:
  push:
    branches: [main]
    paths:
      - 'k8s/**'
      - '.github/workflows/deploy-all.yml'
  workflow_dispatch:
    inputs:
      force_restart:
        description: 'Force restart all pods (even if no changes)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  packages: write

env:
  NAMESPACE: janua

jobs:
  deploy-all:
    name: Deploy All Janua Services
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Get short SHA
        id: sha
        run: echo "short=$(echo ${{ github.sha }} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: Setup kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.3.0'

      - name: Migrate deployments with bad selectors (one-time fix)
        run: |
          echo "=== Checking for deployments with immutable selector labels ==="

          # List of deployments that may have bad selector labels from old commonLabels
          DEPLOYMENTS="janua-admin janua-dashboard janua-docs janua-website"

          for DEPLOY in $DEPLOYMENTS; do
            if kubectl get deployment $DEPLOY -n $NAMESPACE -o jsonpath='{.spec.selector.matchLabels}' 2>/dev/null | grep -q 'app.kubernetes.io'; then
              echo "Found bad selector labels in $DEPLOY - deleting for recreation..."
              kubectl delete deployment $DEPLOY -n $NAMESPACE --ignore-not-found
              echo "Deleted $DEPLOY (will be recreated with correct selectors)"
            else
              echo "OK: $DEPLOY has clean selectors (or doesn't exist yet)"
            fi
          done

          echo "Migration check complete"

      - name: Validate manifests (dry-run)
        run: |
          echo "=== Server-side dry-run validation ==="
          kustomize build k8s/base > /tmp/manifests.yaml

          if ! kubectl apply --dry-run=server -f /tmp/manifests.yaml 2>&1; then
            echo ""
            echo "ERROR: Dry-run failed! Common causes:"
            echo "  - Selector immutability violations (commonLabels issue)"
            echo "  - Resource schema validation errors"
            echo ""
            exit 1
          fi
          echo "Dry-run validation passed"

      - name: Refresh GHCR credentials (namespace-wide)
        env:
          GHCR_TOKEN: ${{ secrets.GHCR_PAT || secrets.GITHUB_TOKEN }}
        run: |
          echo "=== Refreshing GHCR credentials for namespace: $NAMESPACE ==="
          kubectl delete secret ghcr-credentials -n $NAMESPACE --ignore-not-found
          kubectl create secret docker-registry ghcr-credentials \
            --namespace=$NAMESPACE \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=$GHCR_TOKEN \
            --docker-email=ci@janua.dev
          echo "GHCR credentials refreshed"

      - name: Apply K8s manifests
        run: |
          echo "=== Applying K8s manifests ==="
          kubectl apply -k k8s/base/

      - name: Deploy janua-api
        run: |
          echo "=== Deploying janua-api ==="
          IMAGE="ghcr.io/madfam-org/janua-api:latest"

          # Remove Switchyard management labels
          kubectl label deployment janua-api -n $NAMESPACE \
            enclii.dev/managed-by- \
            enclii.dev/project- \
            enclii.dev/release- \
            enclii.dev/deployment- \
            --overwrite 2>/dev/null || true

          # Patch deployment
          kubectl patch deployment janua-api -n $NAMESPACE --type='strategic' -p='
          spec:
            template:
              spec:
                imagePullSecrets:
                  - name: ghcr-credentials
                containers:
                  - name: janua-api
                    image: '$IMAGE'
          '

          # Force rollout if requested
          if [ "${{ inputs.force_restart }}" == "true" ]; then
            kubectl rollout restart deployment/janua-api -n $NAMESPACE
          fi

          kubectl rollout status deployment/janua-api -n $NAMESPACE --timeout=300s

      - name: Deploy janua-dashboard
        run: |
          echo "=== Deploying janua-dashboard ==="
          IMAGE="ghcr.io/madfam-org/janua-dashboard:latest"

          kubectl patch deployment janua-dashboard -n $NAMESPACE --type='strategic' -p='
          spec:
            template:
              spec:
                imagePullSecrets:
                  - name: ghcr-credentials
                containers:
                  - name: janua-dashboard
                    image: '$IMAGE'
          '

          if [ "${{ inputs.force_restart }}" == "true" ]; then
            kubectl rollout restart deployment/janua-dashboard -n $NAMESPACE
          fi

          kubectl rollout status deployment/janua-dashboard -n $NAMESPACE --timeout=180s

      - name: Deploy janua-admin
        run: |
          echo "=== Deploying janua-admin ==="
          IMAGE="ghcr.io/madfam-org/janua-admin:latest"

          kubectl patch deployment janua-admin -n $NAMESPACE --type='strategic' -p='
          spec:
            template:
              spec:
                imagePullSecrets:
                  - name: ghcr-credentials
                containers:
                  - name: janua-admin
                    image: '$IMAGE'
          '

          if [ "${{ inputs.force_restart }}" == "true" ]; then
            kubectl rollout restart deployment/janua-admin -n $NAMESPACE
          fi

          kubectl rollout status deployment/janua-admin -n $NAMESPACE --timeout=180s

      - name: Deploy janua-website
        run: |
          echo "=== Deploying janua-website ==="
          IMAGE="ghcr.io/madfam-org/janua-website:latest"

          kubectl patch deployment janua-website -n $NAMESPACE --type='strategic' -p='
          spec:
            template:
              spec:
                imagePullSecrets:
                  - name: ghcr-credentials
                containers:
                  - name: janua-website
                    image: '$IMAGE'
          '

          if [ "${{ inputs.force_restart }}" == "true" ]; then
            kubectl rollout restart deployment/janua-website -n $NAMESPACE
          fi

          kubectl rollout status deployment/janua-website -n $NAMESPACE --timeout=180s

      - name: Deploy janua-docs (if exists)
        run: |
          echo "=== Deploying janua-docs ==="
          if kubectl get deployment janua-docs -n $NAMESPACE 2>/dev/null; then
            IMAGE="ghcr.io/madfam-org/janua-docs:latest"

            kubectl patch deployment janua-docs -n $NAMESPACE --type='strategic' -p='
            spec:
              template:
                spec:
                  imagePullSecrets:
                    - name: ghcr-credentials
                  containers:
                    - name: janua-docs
                      image: '$IMAGE'
            '

            if [ "${{ inputs.force_restart }}" == "true" ]; then
              kubectl rollout restart deployment/janua-docs -n $NAMESPACE
            fi

            kubectl rollout status deployment/janua-docs -n $NAMESPACE --timeout=180s
          else
            echo "janua-docs deployment not found, skipping"
          fi

      - name: Verify all deployments
        run: |
          echo "=== Verifying All Deployments ==="
          echo ""
          echo "--- Pod Status ---"
          kubectl get pods -n $NAMESPACE -o wide
          echo ""
          echo "--- Deployment Status ---"
          kubectl get deployments -n $NAMESPACE
          echo ""
          echo "--- Service Status ---"
          kubectl get services -n $NAMESPACE
          echo ""

          # Check all pods are Running
          NOT_RUNNING=$(kubectl get pods -n $NAMESPACE --no-headers | grep -v Running | wc -l)
          if [ "$NOT_RUNNING" -gt 0 ]; then
            echo "WARNING: Some pods are not in Running state"
            kubectl get pods -n $NAMESPACE --no-headers | grep -v Running
            exit 1
          fi

          echo "All pods are Running"

      - name: Health check endpoints
        run: |
          echo "=== Health Check via Cloudflare Tunnel ==="

          # Wait for tunnel to pick up new pods
          sleep 30

          # Check each endpoint
          ENDPOINTS=(
            "https://api.janua.dev/health"
            "https://app.janua.dev"
            "https://admin.janua.dev"
            "https://janua.dev"
          )

          FAILED=0
          for URL in "${ENDPOINTS[@]}"; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 "$URL" 2>/dev/null || echo "000")
            if [ "$HTTP_CODE" == "200" ] || [ "$HTTP_CODE" == "302" ] || [ "$HTTP_CODE" == "401" ]; then
              echo "OK: $URL -> $HTTP_CODE"
            else
              echo "FAIL: $URL -> $HTTP_CODE"
              FAILED=$((FAILED + 1))
            fi
          done

          if [ "$FAILED" -gt 0 ]; then
            echo ""
            echo "WARNING: $FAILED endpoint(s) failed health check"
            echo "Note: May need time for Cloudflare tunnel to propagate"
          else
            echo ""
            echo "All endpoints healthy"
          fi
