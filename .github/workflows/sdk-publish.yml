name: SDK Publishing Pipeline

on:
  push:
    branches:
      - main
    paths:
      - "packages/**"
      - ".github/workflows/sdk-publish.yml"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      sdk:
        description: "SDK to publish (all, python, javascript, typescript, go, java, dotnet, ruby, php)"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - python
          - javascript
          - typescript
          - go
          - java
          - dotnet
          - ruby
          - php
      version_bump:
        description: "Version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - major
          - minor
          - patch
          - prerelease

env:
  NODE_VERSION: "18"
  PYTHON_VERSION: "3.9"
  GO_VERSION: "1.21"
  JAVA_VERSION: "11"
  DOTNET_VERSION: "7.0"
  RUBY_VERSION: "3.0"
  PHP_VERSION: "8.2"

jobs:
  # Validate and test all SDKs before publishing
  validate:
    runs-on: ubuntu-latest
    outputs:
      sdks_to_publish: ${{ steps.determine.outputs.sdks }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine SDKs to publish
        id: determine
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.sdk }}" == "all" ]]; then
              echo "sdks=[\"python\",\"javascript\",\"typescript\",\"go\",\"java\",\"dotnet\",\"ruby\",\"php\"]" >> $GITHUB_OUTPUT
            else
              echo "sdks=[\"${{ github.event.inputs.sdk }}\"]" >> $GITHUB_OUTPUT
            fi
          else
            # Detect changed SDKs
            changed_sdks=""
            for sdk in python javascript typescript go java dotnet ruby php; do
              if git diff HEAD~1 --name-only | grep -q "packages/$sdk/"; then
                if [[ -z "$changed_sdks" ]]; then
                  changed_sdks="\"$sdk\""
                else
                  changed_sdks="$changed_sdks,\"$sdk\""
                fi
              fi
            done
            if [[ -z "$changed_sdks" ]]; then
              echo "sdks=[]" >> $GITHUB_OUTPUT
            else
              echo "sdks=[$changed_sdks]" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Calculate version
        id: version
        run: |
          # Get current version from main package
          current_version=$(cat packages/javascript/package.json | jq -r '.version')

          if [[ "${{ github.event_name }}" == "release" ]]; then
            version="${{ github.event.release.tag_name }}"
            version="${version#v}"  # Remove 'v' prefix if present
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Bump version based on input
            npm install -g semver
            version=$(semver -i ${{ github.event.inputs.version_bump }} $current_version)
          else
            # Auto-increment patch version
            npm install -g semver
            version=$(semver -i patch $current_version)
          fi

          echo "version=$version" >> $GITHUB_OUTPUT
          echo "Publishing version: $version"

  # Python SDK (janua-python)
  publish-python:
    needs: validate
    if: contains(fromJson(needs.validate.outputs.sdks_to_publish), 'python')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          cd packages/python
          pip install --upgrade pip
          pip install build twine pytest black mypy
          pip install -e .

      - name: Run tests
        run: |
          cd packages/python
          python -m pytest tests/ -v

      - name: Type check
        run: |
          cd packages/python
          mypy janua --ignore-missing-imports

      - name: Update version
        run: |
          cd packages/python
          sed -i "s/version=\".*\"/version=\"${{ needs.validate.outputs.version }}\"/" setup.py

      - name: Build package
        run: |
          cd packages/python
          python -m build

      - name: Publish to PyPI
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          cd packages/python
          twine upload dist/* --skip-existing

  # JavaScript/TypeScript SDK (janua-js)
  publish-javascript:
    needs: validate
    if: contains(fromJson(needs.validate.outputs.sdks_to_publish), 'javascript') || contains(fromJson(needs.validate.outputs.sdks_to_publish), 'typescript')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: "https://npm.madfam.io"

      - name: Install dependencies
        run: |
          cd packages/javascript
          npm ci

      - name: Run tests
        run: |
          cd packages/javascript
          npm test

      - name: Lint
        run: |
          cd packages/javascript
          npm run lint

      - name: Build
        run: |
          cd packages/javascript
          npm run build

      - name: Update version
        run: |
          cd packages/javascript
          npm version ${{ needs.validate.outputs.version }} --no-git-tag-version

      - name: Publish to NPM
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_MADFAM_TOKEN }}
        run: |
          cd packages/javascript
          npm publish --access restricted

  # Go SDK (github.com/janua/janua-go)
  publish-go:
    needs: validate
    if: contains(fromJson(needs.validate.outputs.sdks_to_publish), 'go')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Test
        run: |
          cd packages/go
          go test ./... -v

      - name: Build
        run: |
          cd packages/go
          go build ./...

      - name: Tag version
        run: |
          cd packages/go
          git tag "go/v${{ needs.validate.outputs.version }}"
          git push origin "go/v${{ needs.validate.outputs.version }}"

  # Java SDK (Maven Central)
  publish-java:
    needs: validate
    if: contains(fromJson(needs.validate.outputs.sdks_to_publish), 'java')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v3
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: "temurin"

      - name: Run tests
        run: |
          cd packages/java
          ./mvnw test

      - name: Update version
        run: |
          cd packages/java
          ./mvnw versions:set -DnewVersion=${{ needs.validate.outputs.version }}

      - name: Build and deploy
        env:
          MAVEN_USERNAME: ${{ secrets.MAVEN_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.MAVEN_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.MAVEN_GPG_PASSPHRASE }}
        run: |
          cd packages/java
          ./mvnw clean deploy -P release

  # .NET SDK (NuGet)
  publish-dotnet:
    needs: validate
    if: contains(fromJson(needs.validate.outputs.sdks_to_publish), 'dotnet')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: |
          cd packages/dotnet
          dotnet restore

      - name: Build
        run: |
          cd packages/dotnet
          dotnet build --configuration Release

      - name: Test
        run: |
          cd packages/dotnet
          dotnet test --no-build --configuration Release

      - name: Pack
        run: |
          cd packages/dotnet
          dotnet pack --configuration Release -p:PackageVersion=${{ needs.validate.outputs.version }}

      - name: Publish to NuGet
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
        run: |
          cd packages/dotnet
          dotnet nuget push bin/Release/*.nupkg --api-key $NUGET_API_KEY --source https://api.nuget.org/v3/index.json

  # Ruby SDK (RubyGems)
  publish-ruby:
    needs: validate
    if: contains(fromJson(needs.validate.outputs.sdks_to_publish), 'ruby')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}

      - name: Install dependencies
        run: |
          cd packages/ruby
          bundle install

      - name: Run tests
        run: |
          cd packages/ruby
          bundle exec rspec

      - name: Update version
        run: |
          cd packages/ruby
          sed -i "s/VERSION = \".*\"/VERSION = \"${{ needs.validate.outputs.version }}\"/" lib/janua/version.rb

      - name: Build gem
        run: |
          cd packages/ruby
          gem build janua.gemspec

      - name: Publish to RubyGems
        env:
          GEM_HOST_API_KEY: ${{ secrets.RUBYGEMS_API_KEY }}
        run: |
          cd packages/ruby
          gem push janua-*.gem

  # PHP SDK (Packagist)
  publish-php:
    needs: validate
    if: contains(fromJson(needs.validate.outputs.sdks_to_publish), 'php')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          tools: composer:v2

      - name: Install dependencies
        run: |
          cd packages/php
          composer install

      - name: Run tests
        run: |
          cd packages/php
          vendor/bin/phpunit

      - name: Update version
        run: |
          cd packages/php
          composer config version ${{ needs.validate.outputs.version }}

      # Packagist auto-updates from GitHub tags
      - name: Tag version
        run: |
          cd packages/php
          git tag "php/v${{ needs.validate.outputs.version }}"
          git push origin "php/v${{ needs.validate.outputs.version }}"

  # Update documentation after all SDKs are published
  update-docs:
    needs:
      [
        publish-python,
        publish-javascript,
        publish-go,
        publish-java,
        publish-dotnet,
        publish-ruby,
        publish-php,
      ]
    if: always() && !cancelled()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update SDK versions in docs
        run: |
          version="${{ needs.validate.outputs.version }}"

          # Update README.md
          sed -i "s/janua-python==.*/janua-python==$version/" README.md
          sed -i "s/janua-js@.*/janua-js@$version/" README.md
          sed -i "s/janua\/janua-go@v.*/janua\/janua-go@v$version/" README.md
          sed -i "s/<version>.*<\/version>/<version>$version<\/version>/" README.md
          sed -i "s/PackageReference Include=\"Janua\" Version=\".*\"/PackageReference Include=\"Janua\" Version=\"$version\"/" README.md
          sed -i "s/gem 'janua', '.*'/gem 'janua', '$version'/" README.md
          sed -i "s/\"janua\/janua\": \".*\"/\"janua\/janua\": \"$version\"/" README.md

      - name: Create PR for documentation updates
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "docs: update SDK versions to ${{ needs.validate.outputs.version }}"
          title: "Update SDK versions to ${{ needs.validate.outputs.version }}"
          body: |
            This PR updates the SDK version references in documentation to ${{ needs.validate.outputs.version }}.

            Published SDKs:
            ${{ toJson(needs.validate.outputs.sdks_to_publish) }}
          branch: update-sdk-versions-${{ needs.validate.outputs.version }}

  # Send notifications
  notify:
    needs: [validate, update-docs]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Send Slack notification
        if: vars.SLACK_WEBHOOK_URL
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          status="${{ job.status }}"
          version="${{ needs.validate.outputs.version }}"
          sdks='${{ needs.validate.outputs.sdks_to_publish }}'

          if [[ "$status" == "success" ]]; then
            emoji=":white_check_mark:"
            text="Successfully published SDKs version $version"
          else
            emoji=":x:"
            text="Failed to publish SDKs version $version"
          fi

          curl -X POST $SLACK_WEBHOOK_URL \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"$emoji SDK Publishing Pipeline\",
              \"attachments\": [{
                \"color\": \"$([[ $status == 'success' ]] && echo 'good' || echo 'danger')\",
                \"fields\": [
                  {\"title\": \"Status\", \"value\": \"$text\", \"short\": false},
                  {\"title\": \"Version\", \"value\": \"$version\", \"short\": true},
                  {\"title\": \"SDKs\", \"value\": \"$sdks\", \"short\": false}
                ]
              }]
            }"
