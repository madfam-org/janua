name: Kubernetes Manifest Validation

on:
  pull_request:
    paths:
      - 'k8s/**'
  push:
    branches: [main]
    paths:
      - 'k8s/**'

jobs:
  validate:
    name: Validate K8s Manifests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: '5.3.0'

      - name: Install kubeconform
        run: |
          curl -sLO https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar xzf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Build and validate base manifests
        run: |
          echo "=== Building k8s/base ==="
          kustomize build k8s/base > /tmp/base.yaml
          echo "=== Validating manifests ==="
          kubeconform -strict -summary -ignore-missing-schemas /tmp/base.yaml

      - name: Check for selector mutations
        run: |
          echo "=== Checking deployment selectors ==="
          kustomize build k8s/base > /tmp/manifests.yaml

          # Extract deployment selectors and check for unexpected labels
          SELECTOR_LABELS=$(cat /tmp/manifests.yaml | grep -A 10 'kind: Deployment' | grep -A 5 'selector:' | grep -A 3 'matchLabels:' | grep -E '^\s+\w+:' | grep -v 'app:' | head -5)

          if [ -n "$SELECTOR_LABELS" ]; then
            echo "ERROR: Deployment selectors contain unexpected labels:"
            echo "$SELECTOR_LABELS"
            echo ""
            echo "This will cause 'field is immutable' errors on existing deployments."
            echo "Check if commonLabels is being used - use 'labels' transformer with includeSelectors: false instead."
            exit 1
          fi

          echo "OK: Deployment selectors only contain expected 'app:' label"
