name: Maintenance Checks

on:
  schedule:
    # Daily at 6 AM UTC
    - cron: '0 6 * * *'
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch: # Allow manual triggering

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Make scripts executable
        run: chmod +x scripts/maintenance/*.sh

      - name: Run code quality checks
        run: ./scripts/maintenance/check-code-quality.sh
        continue-on-error: true
        id: quality

      - name: Upload quality report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: code-quality-report
          path: |
            **/coverage/
            **/test-results/
          retention-days: 7

      - name: Comment PR with quality results
        if: github.event_name == 'pull_request' && steps.quality.outcome != 'success'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ Code quality checks found issues. Please review the maintenance script output.'
            })

  documentation:
    name: Documentation Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Needed for checking file modification dates

      - name: Make scripts executable
        run: chmod +x scripts/maintenance/*.sh

      - name: Run documentation checks
        run: ./scripts/maintenance/check-docs.sh
        continue-on-error: true
        id: docs

      - name: Comment PR with documentation results
        if: github.event_name == 'pull_request' && steps.docs.outcome != 'success'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸ“š Documentation checks found issues. Please review the maintenance script output.'
            })

  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Run pnpm audit
        run: pnpm audit --audit-level=moderate
        continue-on-error: true
        id: audit

      - name: Check for outdated dependencies
        run: pnpm outdated || true

      - name: Create issue for vulnerabilities
        if: steps.audit.outcome != 'success' && github.event_name == 'schedule'
        uses: actions/github-script@v8
        with:
          script: |
            const date = new Date().toISOString().split('T')[0];
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”’ Security vulnerabilities detected - ${date}`,
              body: 'Automated pnpm audit found security vulnerabilities. Please review and update dependencies.',
              labels: ['security', 'dependencies', 'automated']
            })

  build-verification:
    name: Build System Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Run type checking
        run: pnpm typecheck || true

      - name: Run linting
        run: pnpm lint || true

  test-suite:
    name: Test Suite Health
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test -- --coverage
        continue-on-error: true

      - name: Upload coverage
        if: always()
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/coverage-final.json
          flags: unittests
          fail_ci_if_error: false

  maintenance-summary:
    name: Maintenance Summary
    runs-on: ubuntu-latest
    needs: [code-quality, documentation, dependency-audit, build-verification, test-suite]
    if: always()

    steps:
      - name: Create summary
        uses: actions/github-script@v8
        env:
          CODE_QUALITY_RESULT: ${{ needs.code-quality.result }}
          DOCUMENTATION_RESULT: ${{ needs.documentation.result }}
          DEPENDENCY_AUDIT_RESULT: ${{ needs.dependency-audit.result }}
          BUILD_VERIFICATION_RESULT: ${{ needs.build-verification.result }}
          TEST_SUITE_RESULT: ${{ needs.test-suite.result }}
        with:
          script: |
            const getStatus = (result) => result === 'success' ? 'PASS' : 'FAIL';
            const summary = `## Maintenance Check Summary

            **Date**: ${new Date().toISOString().split('T')[0]}

            | Check | Status |
            |-------|--------|
            | Code Quality | ${getStatus(process.env.CODE_QUALITY_RESULT)} |
            | Documentation | ${getStatus(process.env.DOCUMENTATION_RESULT)} |
            | Dependencies | ${getStatus(process.env.DEPENDENCY_AUDIT_RESULT)} |
            | Build System | ${getStatus(process.env.BUILD_VERIFICATION_RESULT)} |
            | Test Suite | ${getStatus(process.env.TEST_SUITE_RESULT)} |

            [View detailed results](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            `;

            core.summary.addRaw(summary).write();
