# MADFAM Secrets Rotation Reminder
#
# Automated weekly check of secrets rotation schedule.
# Sends alerts via Slack and creates GitHub issues for overdue secrets.
#
# Schedule: Every Monday at 9 AM UTC
# Manual trigger: workflow_dispatch

name: Secrets Rotation Reminder

on:
  schedule:
    # Every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      force_notification:
        description: 'Send notification even if no secrets are due'
        required: false
        type: boolean
        default: false

env:
  REGISTRY_PATH: infra/secrets/SECRETS_REGISTRY.yaml

jobs:
  check-rotations:
    name: Check Secrets Rotation Schedule
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    outputs:
      has_overdue: ${{ steps.check.outputs.has_overdue }}
      has_upcoming: ${{ steps.check.outputs.has_upcoming }}
      overdue_count: ${{ steps.check.outputs.overdue_count }}
      report: ${{ steps.check.outputs.report }}
      overdue_list: ${{ steps.check.outputs.overdue_list }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Parse Registry & Check Dates
        id: check
        env:
          SECRETS_REGISTRY_PATH: ${{ env.REGISTRY_PATH }}
        run: |
          python scripts/secrets/check-rotation-schedule.py --github-format

      - name: Display Report
        run: |
          echo "=== Secrets Rotation Status ==="
          python scripts/secrets/check-rotation-schedule.py --output text

  notify-slack:
    name: Send Slack Notification
    needs: check-rotations
    if: |
      needs.check-rotations.outputs.has_overdue == 'true' ||
      needs.check-rotations.outputs.has_upcoming == 'true' ||
      github.event.inputs.force_notification == 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Generate Slack Message
        id: slack-message
        run: |
          MESSAGE=$(python scripts/secrets/check-rotation-schedule.py --output slack)
          echo "message<<EOF" >> $GITHUB_OUTPUT
          echo "$MESSAGE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Send Slack Alert
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "${{ steps.slack-message.outputs.message }}",
              "unfurl_links": false,
              "unfurl_media": false
            }'

  create-issues:
    name: Create Issues for Overdue Secrets
    needs: check-rotations
    if: needs.check-rotations.outputs.has_overdue == 'true'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Get Overdue Secrets Details
        id: details
        run: |
          python scripts/secrets/check-rotation-schedule.py --output json > /tmp/report.json
          cat /tmp/report.json

      - name: Create Issues for Overdue Secrets
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Parse overdue secrets from JSON report
          OVERDUE_LIST="${{ needs.check-rotations.outputs.overdue_list }}"

          if [ -z "$OVERDUE_LIST" ]; then
            echo "No overdue secrets to create issues for"
            exit 0
          fi

          IFS=',' read -ra SECRETS <<< "$OVERDUE_LIST"

          for secret_id in "${SECRETS[@]}"; do
            # Check if issue already exists for this secret
            EXISTING=$(gh issue list --label "secrets-rotation" --search "$secret_id" --state open --json number --jq 'length')

            if [ "$EXISTING" -gt 0 ]; then
              echo "Issue already exists for $secret_id, skipping..."
              continue
            fi

            # Create new issue
            echo "Creating issue for $secret_id..."
            gh issue create \
              --title "ðŸš¨ OVERDUE: Rotate secret $secret_id" \
              --label "security,secrets-rotation,priority:high" \
              --body "## Secret Rotation Overdue

          **Secret ID:** \`$secret_id\`
          **Status:** OVERDUE
          **Detected:** $(date -u +%Y-%m-%dT%H:%M:%SZ)

          ### Action Required

          1. Review the rotation procedure in \`docs/runbooks/secrets/\`
          2. Execute the appropriate rotation script
          3. Update \`infra/secrets/SECRETS_REGISTRY.yaml\` with new rotation date
          4. Close this issue once rotation is complete

          ### References

          - [Secrets Registry](../blob/main/infra/secrets/SECRETS_REGISTRY.yaml)
          - [Emergency Rotation Runbook](../blob/main/docs/runbooks/secrets/EMERGENCY_ROTATION.md)

          ---
          _Auto-generated by secrets-rotation-reminder workflow_"
          done

  summary:
    name: Workflow Summary
    needs: [check-rotations, notify-slack, create-issues]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Generate Summary
        run: |
          echo "## Secrets Rotation Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Overdue | ${{ needs.check-rotations.outputs.overdue_count || '0' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Has Upcoming | ${{ needs.check-rotations.outputs.has_upcoming || 'false' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-rotations.outputs.has_overdue }}" == "true" ]; then
            echo "âš ï¸ **Action Required:** There are overdue secrets that need immediate rotation." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No overdue secrets." >> $GITHUB_STEP_SUMMARY
          fi
