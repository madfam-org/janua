name: Docker Publish

# Consolidated build+deploy workflow for ALL 5 Janua services.
# Builds changed services in parallel, commits all digests in a single commit.
# ArgoCD detects the kustomization.yaml change and syncs to production.

on:
  push:
    branches: [main]
    paths:
      - 'apps/**'
      - 'packages/**'
      - 'Dockerfile.*'
      - 'Dockerfile'
      - 'pnpm-lock.yaml'
      - '!k8s/**'
  workflow_dispatch:
    inputs:
      force_all:
        description: 'Force rebuild ALL services (bypass change detection)'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: write
  packages: write
  id-token: write  # Required for cosign keyless signing via OIDC

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/madfam-org

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      api: ${{ steps.filter.outputs.api }}
      admin: ${{ steps.filter.outputs.admin }}
      dashboard: ${{ steps.filter.outputs.dashboard }}
      docs: ${{ steps.filter.outputs.docs }}
      website: ${{ steps.filter.outputs.website }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'apps/api/**'
              - 'Dockerfile.api'
              - 'Dockerfile'
            admin:
              - 'apps/admin/**'
              - 'packages/ui/**'
              - 'packages/typescript-sdk/**'
              - 'Dockerfile.admin'
              - 'pnpm-lock.yaml'
            dashboard:
              - 'apps/dashboard/**'
              - 'packages/ui/**'
              - 'Dockerfile.dashboard'
              - 'pnpm-lock.yaml'
            docs:
              - 'apps/docs/**'
              - 'Dockerfile.docs'
            website:
              - 'apps/website/**'
              - 'packages/ui/**'
              - 'Dockerfile.website'
              - 'pnpm-lock.yaml'

      - name: Log detected changes
        run: |
          echo "Change Detection Results:"
          echo "  api:       ${{ steps.filter.outputs.api }}"
          echo "  admin:     ${{ steps.filter.outputs.admin }}"
          echo "  dashboard: ${{ steps.filter.outputs.dashboard }}"
          echo "  docs:      ${{ steps.filter.outputs.docs }}"
          echo "  website:   ${{ steps.filter.outputs.website }}"
          echo "  force_all: ${{ inputs.force_all }}"

  build-api:
    name: Build API
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.api == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: madfam-bot
          password: ${{ secrets.MADFAM_BOT_PAT }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.2.4'

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.api
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/janua-api:main
            ${{ env.IMAGE_PREFIX }}/janua-api:${{ github.sha }}
          cache-from: type=gha,scope=janua-api
          cache-to: type=gha,scope=janua-api,mode=max
          provenance: false
          sbom: false

      - name: Sign image with cosign
        if: steps.build.outcome == 'success'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes ${{ env.IMAGE_PREFIX }}/janua-api@${{ steps.build.outputs.digest }}

  build-admin:
    name: Build Admin
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.admin == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: madfam-bot
          password: ${{ secrets.MADFAM_BOT_PAT }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.2.4'

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.admin
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/janua-admin:main
            ${{ env.IMAGE_PREFIX }}/janua-admin:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.janua.dev
          cache-from: type=gha,scope=janua-admin
          cache-to: type=gha,scope=janua-admin,mode=max
          provenance: false
          sbom: false

      - name: Sign image with cosign
        if: steps.build.outcome == 'success'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes ${{ env.IMAGE_PREFIX }}/janua-admin@${{ steps.build.outputs.digest }}

  build-dashboard:
    name: Build Dashboard
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.dashboard == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: madfam-bot
          password: ${{ secrets.MADFAM_BOT_PAT }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.2.4'

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.dashboard
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/janua-dashboard:main
            ${{ env.IMAGE_PREFIX }}/janua-dashboard:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.janua.dev
            NEXT_PUBLIC_APP_URL=https://app.janua.dev
          cache-from: type=gha,scope=janua-dashboard
          cache-to: type=gha,scope=janua-dashboard,mode=max
          provenance: false
          sbom: false

      - name: Sign image with cosign
        if: steps.build.outcome == 'success'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes ${{ env.IMAGE_PREFIX }}/janua-dashboard@${{ steps.build.outputs.digest }}

  build-docs:
    name: Build Docs
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.docs == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: madfam-bot
          password: ${{ secrets.MADFAM_BOT_PAT }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.2.4'

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.docs
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/janua-docs:main
            ${{ env.IMAGE_PREFIX }}/janua-docs:${{ github.sha }}
          cache-from: type=gha,scope=janua-docs
          cache-to: type=gha,scope=janua-docs,mode=max
          provenance: false
          sbom: false

      - name: Sign image with cosign
        if: steps.build.outcome == 'success'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes ${{ env.IMAGE_PREFIX }}/janua-docs@${{ steps.build.outputs.digest }}

  build-website:
    name: Build Website
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.website == 'true' || github.event_name == 'workflow_dispatch'
    outputs:
      digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: madfam-bot
          password: ${{ secrets.MADFAM_BOT_PAT }}

      - name: Install cosign
        uses: sigstore/cosign-installer@v3
        with:
          cosign-release: 'v2.2.4'

      - name: Build and push
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.website
          push: true
          tags: |
            ${{ env.IMAGE_PREFIX }}/janua-website:main
            ${{ env.IMAGE_PREFIX }}/janua-website:${{ github.sha }}
          build-args: |
            NEXT_PUBLIC_API_URL=https://api.janua.dev
            NEXT_PUBLIC_APP_URL=https://app.janua.dev
          cache-from: type=gha,scope=janua-website
          cache-to: type=gha,scope=janua-website,mode=max
          provenance: false
          sbom: false

      - name: Sign image with cosign
        if: steps.build.outcome == 'success'
        env:
          COSIGN_EXPERIMENTAL: "true"
        run: |
          cosign sign --yes ${{ env.IMAGE_PREFIX }}/janua-website@${{ steps.build.outputs.digest }}

  commit-digests:
    name: Commit Digests to Kustomization
    runs-on: ubuntu-latest
    needs: [build-api, build-admin, build-dashboard, build-docs, build-website]
    if: always() && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: Install kustomize
        run: |
          curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
          sudo mv kustomize /usr/local/bin/

      - name: Update digests
        run: |
          cd k8s/base/deployments
          UPDATED=0

          if [ "${{ needs.build-api.result }}" == "success" ] && [ -n "${{ needs.build-api.outputs.digest }}" ]; then
            echo "Updating janua-api digest: ${{ needs.build-api.outputs.digest }}"
            kustomize edit set image ghcr.io/madfam-org/janua-api=ghcr.io/madfam-org/janua-api@${{ needs.build-api.outputs.digest }}
            UPDATED=$((UPDATED + 1))
          fi

          if [ "${{ needs.build-admin.result }}" == "success" ] && [ -n "${{ needs.build-admin.outputs.digest }}" ]; then
            echo "Updating janua-admin digest: ${{ needs.build-admin.outputs.digest }}"
            kustomize edit set image ghcr.io/madfam-org/janua-admin=ghcr.io/madfam-org/janua-admin@${{ needs.build-admin.outputs.digest }}
            UPDATED=$((UPDATED + 1))
          fi

          if [ "${{ needs.build-dashboard.result }}" == "success" ] && [ -n "${{ needs.build-dashboard.outputs.digest }}" ]; then
            echo "Updating janua-dashboard digest: ${{ needs.build-dashboard.outputs.digest }}"
            kustomize edit set image ghcr.io/madfam-org/janua-dashboard=ghcr.io/madfam-org/janua-dashboard@${{ needs.build-dashboard.outputs.digest }}
            UPDATED=$((UPDATED + 1))
          fi

          if [ "${{ needs.build-docs.result }}" == "success" ] && [ -n "${{ needs.build-docs.outputs.digest }}" ]; then
            echo "Updating janua-docs digest: ${{ needs.build-docs.outputs.digest }}"
            kustomize edit set image ghcr.io/madfam-org/janua-docs=ghcr.io/madfam-org/janua-docs@${{ needs.build-docs.outputs.digest }}
            UPDATED=$((UPDATED + 1))
          fi

          if [ "${{ needs.build-website.result }}" == "success" ] && [ -n "${{ needs.build-website.outputs.digest }}" ]; then
            echo "Updating janua-website digest: ${{ needs.build-website.outputs.digest }}"
            kustomize edit set image ghcr.io/madfam-org/janua-website=ghcr.io/madfam-org/janua-website@${{ needs.build-website.outputs.digest }}
            UPDATED=$((UPDATED + 1))
          fi

          echo "Updated $UPDATED service digest(s)"

          if [ "$UPDATED" -eq 0 ]; then
            echo "No services built successfully â€” skipping commit"
            exit 0
          fi

          cd ${{ github.workspace }}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Save the kustomization.yaml content we just modified
          cp k8s/base/deployments/kustomization.yaml /tmp/kustomization-updated.yaml

          # Retry loop: handles concurrent pushes
          for ATTEMPT in 1 2 3; do
            echo "Push attempt $ATTEMPT/3"
            git fetch origin main
            git reset --hard origin/main

            # Re-apply our digest changes on top of latest remote
            cp /tmp/kustomization-updated.yaml k8s/base/deployments/kustomization.yaml

            git add k8s/base/deployments/kustomization.yaml
            git diff --staged --quiet && { echo "No changes to commit"; exit 0; }
            git commit -m "chore(deploy): update $UPDATED janua service digest(s)"

            if git push origin main; then
              echo "Push succeeded on attempt $ATTEMPT"
              exit 0
            fi
            echo "Push failed (likely concurrent update), retrying..."
            sleep $((ATTEMPT * 2))
          done
          echo "ERROR: Failed to push after 3 attempts"
          exit 1

  report-lifecycle:
    name: Report Lifecycle Events
    runs-on: ubuntu-latest
    needs: [build-api, build-admin, build-dashboard, build-docs, build-website]
    if: always()
    steps:
      - name: Report events
        run: |
          report_event() {
            local SERVICE="$1"
            local RESULT="$2"
            local DIGEST="$3"

            if [ "$RESULT" == "success" ]; then
              EVENT_TYPE="image_pushed"
            elif [ "$RESULT" == "failure" ]; then
              EVENT_TYPE="build_failed"
            else
              return 0
            fi

            curl -sf -X POST "https://api.enclii.dev/v1/callbacks/lifecycle-event" \
              -H "Authorization: Bearer ${{ secrets.ENCLII_CALLBACK_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d '{
                "repo_full_name": "madfam-org/janua",
                "commit_sha": "${{ github.sha }}",
                "branch": "${{ github.ref_name }}",
                "ref": "${{ github.ref }}",
                "event_type": "'"$EVENT_TYPE"'",
                "source": "ci_callback",
                "message": "'"$SERVICE"' build '"$EVENT_TYPE"'",
                "metadata": {
                  "image": "ghcr.io/madfam-org/'"$SERVICE"'",
                  "digest": "'"$DIGEST"'",
                  "workflow": "docker-publish",
                  "service": "'"$SERVICE"'"
                }
              }' || true
          }

          report_event "janua-api" "${{ needs.build-api.result }}" "${{ needs.build-api.outputs.digest }}"
          report_event "janua-admin" "${{ needs.build-admin.result }}" "${{ needs.build-admin.outputs.digest }}"
          report_event "janua-dashboard" "${{ needs.build-dashboard.result }}" "${{ needs.build-dashboard.outputs.digest }}"
          report_event "janua-docs" "${{ needs.build-docs.result }}" "${{ needs.build-docs.outputs.digest }}"
          report_event "janua-website" "${{ needs.build-website.result }}" "${{ needs.build-website.outputs.digest }}"
