name: Unified Recovery - Deploy Switchyard + Fix Janua

# Comprehensive recovery workflow that:
# 1. Deploys the new Switchyard with opt-out fix
# 2. Waits for Switchyard to be healthy
# 3. Fixes janua-api deployment with correct image

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "recover-all" to confirm'
        required: true
        default: ''
        type: string
      switchyard_image:
        description: 'Switchyard image tag (default: latest from CI)'
        required: false
        default: 'ddf9def59877454eb87e25ef85cde1ac566ae3b8'
        type: string

permissions:
  contents: read
  packages: read

jobs:
  unified-recovery:
    name: Unified Recovery
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'recover-all'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster access
        run: |
          echo "=== Verifying cluster access ==="
          kubectl cluster-info
          kubectl get nodes

      - name: Pre-recovery diagnostics
        run: |
          echo "=== Current Cluster State ==="
          echo ""
          echo "--- Switchyard Status ---"
          kubectl get deployment switchyard-api -n enclii -o wide || echo "Switchyard deployment not found"
          kubectl get pods -n enclii -l app=switchyard-api -o wide || true
          echo ""
          echo "--- Janua Status ---"
          kubectl get deployment janua-api -n janua -o wide || echo "Janua deployment not found"
          kubectl get pods -n janua -l app=janua-api -o wide || true

      - name: Step 1 - Deploy new Switchyard with opt-out fix
        env:
          SWITCHYARD_IMAGE: ghcr.io/madfam-org/enclii/switchyard-api:${{ github.event.inputs.switchyard_image }}
        run: |
          echo "=== Deploying Switchyard with opt-out fix ==="
          echo "Image: $SWITCHYARD_IMAGE"

          # Refresh GHCR credentials for enclii namespace
          kubectl delete secret ghcr-credentials -n enclii --ignore-not-found
          kubectl create secret docker-registry ghcr-credentials \
            --namespace=enclii \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --docker-email=ci@enclii.dev

          # Update Switchyard deployment with new image
          kubectl set image deployment/switchyard-api \
            switchyard-api=$SWITCHYARD_IMAGE \
            -n enclii

          # Force pull the new image
          kubectl patch deployment switchyard-api -n enclii -p '{"spec":{"template":{"spec":{"containers":[{"name":"switchyard-api","imagePullPolicy":"Always"}]}}}}'

          # Ensure replicas are set
          kubectl scale deployment switchyard-api -n enclii --replicas=2

          echo "Waiting for Switchyard rollout..."
          kubectl rollout status deployment/switchyard-api -n enclii --timeout=300s || {
            echo "=== Switchyard rollout failed - checking pod status ==="
            kubectl describe pods -n enclii -l app=switchyard-api
            kubectl logs -n enclii -l app=switchyard-api --tail=50
            exit 1
          }

          echo "=== Switchyard deployed successfully ==="
          kubectl get pods -n enclii -l app=switchyard-api

      - name: Step 2 - Verify Switchyard health
        run: |
          echo "=== Verifying Switchyard health ==="
          sleep 30  # Give it time to stabilize

          # Check if pods are running
          READY_PODS=$(kubectl get pods -n enclii -l app=switchyard-api -o jsonpath='{.items[*].status.containerStatuses[0].ready}' | tr ' ' '\n' | grep -c true || echo 0)
          echo "Ready pods: $READY_PODS"

          if [ "$READY_PODS" -lt 1 ]; then
            echo "ERROR: No healthy Switchyard pods"
            kubectl describe pods -n enclii -l app=switchyard-api
            exit 1
          fi

          echo "Switchyard is healthy with $READY_PODS ready pods"

      - name: Step 3 - Fix janua-api deployment
        run: |
          echo "=== Fixing janua-api deployment ==="

          # Refresh GHCR credentials for janua namespace
          kubectl delete secret ghcr-credentials -n janua --ignore-not-found
          kubectl create secret docker-registry ghcr-credentials \
            --namespace=janua \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --docker-email=ci@janua.dev

          # Scale down to reset
          kubectl scale deployment janua-api -n janua --replicas=0 || true
          sleep 5

          # Delete old ReplicaSets
          kubectl delete rs -n janua -l app=janua-api --ignore-not-found

          # Patch deployment with correct configuration
          kubectl patch deployment janua-api -n janua --type='strategic' -p='
          spec:
            replicas: 2
            template:
              metadata:
                annotations:
                  enclii.dev/reconcile: "disabled"
              spec:
                imagePullSecrets:
                  - name: ghcr-credentials
                containers:
                  - name: janua-api
                    image: ghcr.io/madfam-org/janua-api:latest
                    imagePullPolicy: Always
          '

          echo "Waiting for janua-api rollout..."
          kubectl rollout status deployment/janua-api -n janua --timeout=300s || {
            echo "=== Janua rollout failed - checking pod status ==="
            kubectl describe pods -n janua -l app=janua-api
            kubectl logs -n janua -l app=janua-api --tail=50
            exit 1
          }

          echo "=== janua-api deployed successfully ==="
          kubectl get pods -n janua -l app=janua-api

      - name: Post-recovery verification
        run: |
          echo "=========================================="
          echo "  UNIFIED RECOVERY COMPLETE"
          echo "=========================================="
          echo ""
          echo "--- Final Switchyard Status ---"
          kubectl get pods -n enclii -l app=switchyard-api -o wide
          echo ""
          echo "--- Final Janua Status ---"
          kubectl get pods -n janua -l app=janua-api -o wide
          echo ""
          echo "--- Service Endpoints ---"
          kubectl get svc -n enclii switchyard-api
          kubectl get svc -n janua janua-api
          echo ""
          echo "Recovery complete. Please verify services at:"
          echo "  - https://janua.dev"
          echo "  - https://api.janua.dev"
          echo "  - https://admin.janua.dev"
          echo "  - https://app.janua.dev"
