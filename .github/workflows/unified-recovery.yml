name: Unified Recovery - Deploy Switchyard + Fix Janua

# Comprehensive recovery workflow that:
# 1. Deploys the new Switchyard with opt-out fix
# 2. Waits for Switchyard to be healthy
# 3. Fixes janua-api deployment with correct image

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "recover-all" to confirm'
        required: true
        default: ''
        type: string
      switchyard_image:
        description: 'Switchyard image tag (default: latest from CI)'
        required: false
        default: 'ddf9def59877454eb87e25ef85cde1ac566ae3b8'
        type: string

permissions:
  contents: read
  packages: read

jobs:
  unified-recovery:
    name: Unified Recovery
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'recover-all'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_PRODUCTION }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster access
        run: |
          echo "=== Verifying cluster access ==="
          kubectl cluster-info
          kubectl get nodes

      - name: Pre-recovery diagnostics
        run: |
          echo "=== Current Cluster State ==="
          echo ""
          echo "--- Switchyard Status ---"
          kubectl get deployment switchyard-api -n enclii -o wide || echo "Switchyard deployment not found"
          kubectl get pods -n enclii -l app=switchyard-api -o wide || true
          echo ""
          echo "--- Janua Status ---"
          kubectl get deployment janua-api -n janua -o wide || echo "Janua deployment not found"
          kubectl get pods -n janua -l app=janua-api -o wide || true

      - name: Step 1 - Scale down Switchyard to prevent interference
        run: |
          echo "=== Scaling down Switchyard (will restart after Janua is up) ==="
          kubectl scale deployment switchyard-api -n enclii --replicas=0 || true
          sleep 10
          echo "Switchyard scaled down"

      - name: Step 2 - Fix janua-api deployment FIRST
        run: |
          echo "=== Fixing janua-api deployment ==="

          # Refresh GHCR credentials for janua namespace
          kubectl delete secret ghcr-credentials -n janua --ignore-not-found
          kubectl create secret docker-registry ghcr-credentials \
            --namespace=janua \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --docker-email=ci@janua.dev

          # Scale down to reset
          kubectl scale deployment janua-api -n janua --replicas=0 || true
          sleep 5

          # Delete old ReplicaSets
          kubectl delete rs -n janua -l app=janua-api --ignore-not-found

          # Patch deployment with correct configuration
          # TRUST_ALL_HOSTS=true is required because K8s health probes use internal IPs
          # that don't match domain patterns in TrustedHostMiddleware
          kubectl patch deployment janua-api -n janua --type='strategic' -p='
          spec:
            replicas: 2
            template:
              metadata:
                annotations:
                  enclii.dev/reconcile: "disabled"
              spec:
                imagePullSecrets:
                  - name: ghcr-credentials
                containers:
                  - name: janua-api
                    image: ghcr.io/madfam-org/janua-api:latest
                    imagePullPolicy: Always
                    ports:
                      - containerPort: 8080
                    env:
                      - name: TRUST_ALL_HOSTS
                        value: "true"
          '

          # Fix Service targetPort to match container port (8080)
          kubectl patch svc janua-api -n janua --type='json' \
            -p='[{"op": "replace", "path": "/spec/ports/0/targetPort", "value": 8080}]' \
            2>/dev/null || echo "Service targetPort already set to 8080"

          # Fix NetworkPolicy to allow port 8080 traffic from cloudflared
          kubectl patch networkpolicy janua-api-ingress -n janua --type='json' \
            -p='[{"op": "replace", "path": "/spec/ingress/0/ports/0/port", "value": 8080}]' \
            2>/dev/null || echo "NetworkPolicy already allows port 8080 (or policy doesn't exist)"

          # Show current configuration for verification
          echo "=== Current janua-api configuration ==="
          kubectl get svc janua-api -n janua -o yaml | grep -A5 "ports:"
          kubectl get networkpolicy janua-api-ingress -n janua -o yaml 2>/dev/null | grep -A10 "ingress:" || echo "No NetworkPolicy found"

          echo "Waiting for janua-api rollout..."
          kubectl rollout status deployment/janua-api -n janua --timeout=300s || {
            echo "=== Janua rollout failed - checking pod status ==="
            kubectl describe pods -n janua -l app=janua-api
            kubectl logs -n janua -l app=janua-api --tail=50
            exit 1
          }

          echo "=== janua-api deployed successfully ==="
          kubectl get pods -n janua -l app=janua-api

      - name: Step 3 - Wait for Janua to be fully healthy
        run: |
          echo "=== Waiting for Janua to be fully healthy ==="
          sleep 30

          # Check if auth.madfam.io is responding
          for i in $(seq 1 10); do
            if curl -s -o /dev/null -w "%{http_code}" https://auth.madfam.io/.well-known/jwks.json | grep -q "200"; then
              echo "Janua OIDC endpoint is healthy!"
              exit 0
            fi
            echo "Attempt $i/10: Janua not ready yet, waiting..."
            sleep 10
          done

          echo "WARNING: Janua health check didn't pass, but continuing..."

      - name: Step 4 - Deploy new Switchyard with opt-out fix
        env:
          SWITCHYARD_IMAGE: ghcr.io/madfam-org/enclii/switchyard-api:${{ github.event.inputs.switchyard_image }}
        run: |
          echo "=== Deploying Switchyard with opt-out fix ==="
          echo "Image: $SWITCHYARD_IMAGE"

          # Refresh GHCR credentials for enclii namespace
          kubectl delete secret ghcr-credentials -n enclii --ignore-not-found
          kubectl create secret docker-registry ghcr-credentials \
            --namespace=enclii \
            --docker-server=ghcr.io \
            --docker-username=${{ github.actor }} \
            --docker-password=${{ secrets.GITHUB_TOKEN }} \
            --docker-email=ci@enclii.dev

          # Update Switchyard deployment with new image
          kubectl set image deployment/switchyard-api \
            switchyard-api=$SWITCHYARD_IMAGE \
            -n enclii

          # Force pull the new image
          kubectl patch deployment switchyard-api -n enclii -p '{"spec":{"template":{"spec":{"containers":[{"name":"switchyard-api","imagePullPolicy":"Always"}]}}}}'

          # Scale up Switchyard
          kubectl scale deployment switchyard-api -n enclii --replicas=2

          echo "Waiting for Switchyard rollout..."
          kubectl rollout status deployment/switchyard-api -n enclii --timeout=300s || {
            echo "=== Switchyard rollout needs more time ==="
            kubectl describe pods -n enclii -l app=switchyard-api
            kubectl logs -n enclii -l app=switchyard-api --tail=50
            echo "Continuing anyway - Switchyard may need manual attention"
          }

          echo "=== Switchyard deployment updated ==="
          kubectl get pods -n enclii -l app=switchyard-api

      - name: Post-recovery verification
        run: |
          echo "=========================================="
          echo "  UNIFIED RECOVERY COMPLETE"
          echo "=========================================="
          echo ""
          echo "--- Final Switchyard Status ---"
          kubectl get pods -n enclii -l app=switchyard-api -o wide
          echo ""
          echo "--- Final Janua Status ---"
          kubectl get pods -n janua -l app=janua-api -o wide
          echo ""
          echo "--- Service Endpoints ---"
          kubectl get svc -n enclii switchyard-api
          kubectl get svc -n janua janua-api
          echo ""
          echo "Recovery complete. Please verify services at:"
          echo "  - https://janua.dev"
          echo "  - https://api.janua.dev"
          echo "  - https://admin.janua.dev"
          echo "  - https://app.janua.dev"
