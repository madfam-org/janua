name: SDK CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'packages/**'
      - '.github/workflows/sdk-ci.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'packages/**'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  npm-sdks:
    name: Test NPM SDKs
    runs-on: ubuntu-latest
    strategy:
      matrix:
        sdk: [typescript-sdk, react-sdk, nextjs-sdk, vue-sdk]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build SDK
        run: |
          # Always build typescript-sdk first (dependency for other SDKs)
          if [ "${{ matrix.sdk }}" != "typescript-sdk" ]; then
            echo "Building typescript-sdk dependency first..."
            cd packages/typescript-sdk && pnpm build
            cd ../..
          fi
          # Build the target SDK
          cd packages/${{ matrix.sdk }}
          pnpm build

      - name: Run tests
        run: |
          cd packages/${{ matrix.sdk }}
          pnpm test || true

      - name: Run linter
        run: |
          cd packages/${{ matrix.sdk }}
          pnpm lint || true

      - name: Run typecheck
        run: |
          cd packages/${{ matrix.sdk }}
          pnpm typecheck || true

      - name: Verify dist/
        run: |
          if [ ! -d "packages/${{ matrix.sdk }}/dist" ]; then
            echo "❌ dist/ directory not found"
            exit 1
          fi
          FILE_COUNT=$(find packages/${{ matrix.sdk }}/dist -type f | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "❌ dist/ directory is empty"
            exit 1
          fi
          echo "✅ dist/ contains $FILE_COUNT files"

  python-sdk:
    name: Test Python SDK
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install build twine
          cd packages/python-sdk
          pip install -e .[dev]

      - name: Build distributions
        run: |
          cd packages/python-sdk
          python -m build

      - name: Check distributions
        run: |
          cd packages/python-sdk
          twine check dist/*

      - name: Run tests
        run: |
          cd packages/python-sdk
          pytest tests/ -v || true

      - name: Verify dist/
        run: |
          if [ ! -d "packages/python-sdk/dist" ]; then
            echo "❌ dist/ directory not found"
            exit 1
          fi
          WHEEL_COUNT=$(find packages/python-sdk/dist -name "*.whl" | wc -l)
          SDIST_COUNT=$(find packages/python-sdk/dist -name "*.tar.gz" | wc -l)
          if [ "$WHEEL_COUNT" -eq 0 ] || [ "$SDIST_COUNT" -eq 0 ]; then
            echo "❌ Missing wheel or sdist"
            exit 1
          fi
          echo "✅ Found $WHEEL_COUNT wheel(s) and $SDIST_COUNT sdist(s)"

  go-sdk:
    name: Test Go SDK
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.22', '1.23']

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Verify dependencies
        run: |
          cd packages/go-sdk
          go mod verify
          go mod tidy
          # Check if go.mod changed
          git diff --exit-code go.mod go.sum

      - name: Build
        run: |
          cd packages/go-sdk
          go build -v ./...

      - name: Run tests
        run: |
          cd packages/go-sdk
          go test -v -race -coverprofile=coverage.out ./...

      - name: Run linter
        uses: golangci/golangci-lint-action@v6
        with:
          version: v1.62.2
          working-directory: packages/go-sdk

  flutter-sdk:
    name: Test Flutter SDK
    runs-on: ubuntu-latest
    strategy:
      matrix:
        flutter-version: ['3.24.0']

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Flutter ${{ matrix.flutter-version }}
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ matrix.flutter-version }}
          channel: 'stable'

      - name: Verify Flutter installation
        run: flutter --version

      - name: Get dependencies
        run: |
          cd packages/flutter-sdk
          flutter pub get

      - name: Analyze code
        run: |
          cd packages/flutter-sdk
          flutter analyze --no-fatal-infos || true

      - name: Run tests
        run: |
          cd packages/flutter-sdk
          flutter test || true

      - name: Verify build
        run: |
          cd packages/flutter-sdk
          # Verify package structure
          if [ ! -f "lib/janua_flutter.dart" ]; then
            echo "❌ Main library file not found"
            exit 1
          fi
          echo "✅ Flutter SDK structure verified"

  react-native-sdk:
    name: Test React Native SDK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build SDK
        run: |
          cd packages/react-native-sdk
          pnpm build || npm run build || echo "No build script, checking source..."

      - name: Verify TypeScript definitions
        run: |
          cd packages/react-native-sdk
          if [ ! -f "src/index.d.ts" ]; then
            echo "❌ TypeScript definitions not found"
            exit 1
          fi
          echo "✅ TypeScript definitions found"

      - name: Run tests
        run: |
          cd packages/react-native-sdk
          pnpm test || npm test || echo "No test script configured"
